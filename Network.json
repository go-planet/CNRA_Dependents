{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "OwnerTag": {
            "defaultValue": "Operations",
            "type": "String",
            "metadata": {
                "description": "Tags all resources created with Owner's name"
            }
        },
        "EmailTag": {
            "defaultValue": "operations@contoso.com",
            "type": "String",
            "metadata": {
                "description": "Tags all resources created with Owner's Email"
            }
        },
        "ProdVNetName": {
            "defaultValue": "PrdVirtualNetwork",
            "type": "String",
            "metadata": {
                "description": "Name of the Production Virtual Network"
            }
        },
        "ProdVNetPrefix": {
            "defaultValue": "10.0.0.0/22",
            "type": "String",
            "metadata": {
                "description": "This is the address space used to create the Production VNET"
            }
        },
        "deploydev": {
            "defaultValue": "Yes",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "type": "String",
            "metadata": {
                "description": "Enables deployment of Development Environment"
            }
        },
        "DevVNetName": {
            "defaultValue": "DevVirtualNetwork",
            "type": "String",
            "metadata": {
                "description": "Name of the Production Virtual Network"
            }
        },
        "DevVNetPrefix": {
            "defaultValue": "10.0.4.0/22",
            "type": "String",
            "metadata": {
                "description": "This is the address space used to create the Development VNET"
            }
        },
        "DevSubscriptionId": {
            "defaultValue": "",
            "type": "String",
            "metadata": {
                "description": "Subscription ID in the format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
            }
        },
        "DevResourceGroup": {
            "defaultValue": "dev_netw_rg",
            "type": "String",
            "metadata": {
                "description": "Resource Group for Development subscription Network Infrastructure"
            }
        },
        "deployazurefirewall": {
            "defaultValue": "Yes",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "type": "String",
            "metadata": {
                "description": "Enables deployment of Azure Firewall"
            }
        },
        "VNetGatewayName": {
            "defaultValue": "VirtualNetworkGateway",
            "type": "String",
            "metadata": {
                "description": "Name of the Virtual Network Gateway"
            }
        },
        "LocalNetworkGatewayName": {
            "defaultValue": "LocalNetworkGateway",
            "type": "String",
            "metadata": {
                "description": "Name of the Local Network Gateway"
            }
        },
        "LocalNetworkGatewayAddressSpace": {
            "defaultValue": [
                "10.0.0.0/8",
                "172.16.0.0/12",
                "192.168.0.0/16"
            ],
            "type": "Array",
            "metadata": {
                "description": "Array of CIDR Prefixes for Local Network Gateway"
            }
        },
        "LocalNetworkGatewayIP": {
            "defaultValue": "0.0.0.0",
            "type": "String",
            "metadata": {
                "description": "IP of the VPN Peer that the Local Network Gateway will connect to"
            }
        },
        "AzureFirewallName": {
            "defaultValue": "AzureFirewall",
            "type": "String",
            "metadata": {
                "description": "Name of the Azure Firewall"
            }
        },
        "GatewaySubnetPrefix": {
            "defaultValue": "10.0.0.0/27",
            "type": "String",
            "metadata": {
                "description": "Address space for the Production Subscription Gateway Subnet"
            }
        },
        "GatewayRouteTableName": {
            "defaultValue": "prd_rt_gateway",
            "type": "String",
            "metadata": {
                "description": "Name for the Production Subscription Gateway Subnet's Route Table"
            }
        },
        "AzureFirewallSubnetPrefix": {
            "defaultValue": "10.0.0.64/26",
            "type": "String",
            "metadata": {
                "description": "Address space for the Production Subscription Azure Firewall Subnet"
            }
        },
        "AzureFirewallRouteTableName": {
            "defaultValue": "prd_rt_azurefirewall",
            "type": "String",
            "metadata": {
                "description": "Name for the Production Subscription Azure Firewall Subnet's Route Table"
            }
        },
        "AppGatewaySubnetName": {
            "defaultValue": "AppGateway",
            "type": "String",
            "metadata": {
                "description": "Name for the Production Subscription Application Gateway Subnet"
            }
        },
        "AppGatewaySubnetPrefix": {
            "defaultValue": "10.0.0.32/27",
            "type": "String",
            "metadata": {
                "description": "Address space for the Production Subscription Application Gateway Subnet"
            }
        },
        "AppGatewayRouteTableName": {
            "defaultValue": "prd_rt_appgateway",
            "type": "String",
            "metadata": {
                "description": "Name for the Production Subscription AppGateway Subnet's Route Table"
            }
        },
        "ADSubnetName": {
            "defaultValue": "AD",
            "type": "String",
            "metadata": {
                "description": "Name for the Production Subscription AD Subnet"
            }
        },
        "ADSubnetPrefix": {
            "defaultValue": "10.0.0.192/27",
            "type": "String",
            "metadata": {
                "description": "Address space for the Production Subscription AD Subnet"
            }
        },
        "ADRouteTableName": {
            "defaultValue": "prd_rt_ad",
            "type": "String",
            "metadata": {
                "description": "Name for the Production Subscription AD Subnet's Route Table"
            }
        },
        "PrdApplicationSubnetName": {
            "defaultValue": "Apps",
            "type": "String",
            "metadata": {
                "description": "Name for the Production Subscription Application Subnet"
            }
        },
        "PrdApplicationSubnetPrefix": {
            "defaultValue": "10.0.1.0/24",
            "type": "String",
            "metadata": {
                "description": "Address space for the Production Subscription Application Subnet"
            }
        },
        "PrdApplicationRouteTableName": {
            "defaultValue": "prd_rt_apps",
            "type": "String",
            "metadata": {
                "description": "Name for the Production Subscription Apps Subnet's Route Table"
            }
        },
        "PrdDataSubnetName": {
            "defaultValue": "Data",
            "type": "String",
            "metadata": {
                "description": "Name for the Production Subscription Data Subnet"
            }
        },
        "PrdDataSubnetPrefix": {
            "defaultValue": "10.0.2.0/24",
            "type": "String",
            "metadata": {
                "description": "Address space for the Production Subscription Data Subnet"
            }
        },
        "PrdDataRouteTableName": {
            "defaultValue": "prd_rt_data",
            "type": "String",
            "metadata": {
                "description": "Name for the Production Subscription Data Subnet's Route Table"
            }
        },
        "PrdWebSubnetName": {
            "defaultValue": "Web",
            "type": "String",
            "metadata": {
                "description": "Name for the Production Subscription Web Subnet"
            }
        },
        "PrdWebSubnetPrefix": {
            "defaultValue": "10.0.3.0/24",
            "type": "String",
            "metadata": {
                "description": "Address space for the Production Subscription Web Subnet"
            }
        },
        "PrdWebRouteTableName": {
            "defaultValue": "prd_rt_web",
            "type": "String",
            "metadata": {
                "description": "Name for the Production Subscription Web Subnet's Route Table"
            }
        },
        "DevApplicationSubnetName": {
            "defaultValue": "Apps",
            "type": "String",
            "metadata": {
                "description": "Name for the Development Subscription Application Subnet"
            }
        },
        "DevApplicationSubnetPrefix": {
            "defaultValue": "10.0.5.0/24",
            "type": "String",
            "metadata": {
                "description": "Address space for the Development Subscription Application Subnet"
            }
        },
        "DevApplicationRouteTableName": {
            "defaultValue": "dev_rt_apps",
            "type": "String",
            "metadata": {
                "description": "Name for the Development Subscription Apps Subnet's Route Table"
            }
        },
        "DevDataSubnetName": {
            "defaultValue": "Data",
            "type": "String",
            "metadata": {
                "description": "Name for the Development Subscription Data Subnet"
            }
        },
        "DevDataSubnetPrefix": {
            "defaultValue": "10.0.6.0/24",
            "type": "String",
            "metadata": {
                "description": "Address space for the Development Subscription Data Subnet"
            }
        },
        "DevDataRouteTableName": {
            "defaultValue": "dev_rt_data",
            "type": "String",
            "metadata": {
                "description": "Name for the Development Subscription Data Subnet's Route Table"
            }
        },
        "DevWebSubnetName": {
            "defaultValue": "Web",
            "type": "String",
            "metadata": {
                "description": "Name for the Development Subscription Web Subnet"
            }
        },
        "DevWebSubnetPrefix": {
            "defaultValue": "10.0.7.0/24",
            "type": "String",
            "metadata": {
                "description": "Address space for the Development Subscription Web Subnet"
            }
        },
        "DevWebRouteTableName": {
            "defaultValue": "dev_rt_web",
            "type": "String",
            "metadata": {
                "description": "Name for the Development Subscription Web Subnet's Route Table"
            }
        }
    },
    "variables": {
        "GatewayRouteName": "[toLower(concat(parameters('GatewayRouteTableName'),'_',replace(parameters('GatewaySubnetPrefix'),'/','_')))]",
        "AzureFirewallRouteName": "[toLower(concat(parameters('AzureFirewallRouteTableName'),'_',replace(parameters('AzureFirewallSubnetPrefix'),'/','_')))]",
        "AppGatewayRouteName": "[toLower(concat(parameters('AppGatewayRouteTableName'),'_',replace(parameters('AppGatewaySubnetPrefix'),'/','_')))]",
        "ADRouteName": "[toLower(concat(parameters('ADRouteTableName'),'_',replace(parameters('ADSubnetPrefix'),'/','_')))]",
        "PrdApplicationRouteName": "[toLower(concat(parameters('PrdApplicationRouteTableName'),'_',replace(parameters('PrdApplicationSubnetPrefix'),'/','_')))]",
        "PrdDataRouteName": "[toLower(concat(parameters('PrdDataRouteTableName'),'_',replace(parameters('PrdDataSubnetPrefix'),'/','_')))]",
        "PrdWebRouteName": "[toLower(concat(parameters('PrdWebRouteTableName'),'_',replace(parameters('PrdWebSubnetPrefix'),'/','_')))]",
        "DevApplicationRouteName": "[toLower(concat(parameters('DevApplicationRouteTableName'),'_',replace(parameters('DevApplicationSubnetPrefix'),'/','_')))]",
        "DevDataRouteName": "[toLower(concat(parameters('DevDataRouteTableName'),'_',replace(parameters('DevDataSubnetPrefix'),'/','_')))]",
        "DevWebRouteName": "[toLower(concat(parameters('DevWebRouteTableName'),'_',replace(parameters('DevWebSubnetPrefix'),'/','_')))]",
        "VNetGatewayPIPName": "[concat(parameters('VNetGatewayName'),'_pip')]",
        "AzureFirewallPIPName": "[concat(parameters('AzureFirewallName'),'_pip')]",
        "GatewaySubnetRef": "[concat(resourceId('Microsoft.Network/virtualNetworks',parameters('ProdVNetName')),'/subnets/','GatewaySubnet')]",
        "ProdSubID": "[subscription().subscriptionId]",
        "ProdRGName": "[resourceGroup().name]",
        "ProdVNetID": "[resourceId(variables('ProdSubID'),variables('ProdRGName'),'Microsoft.Network/virtualNetworks',parameters('ProdVNetName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Network/virtualNetworks",
            "name": "[parameters('ProdVNetName')]",
            "apiVersion": "2015-06-15",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[parameters('ProdVNetPrefix')]"
                    ]
                },
                "subnets": [
                    {
                        "name": "GatewaySubnet",
                        "properties": {
                            "addressPrefix": "[parameters('GatewaySubnetPrefix')]"
                        }
                    },
                    {
                        "name": "AzureFirewallSubnet",
                        "properties": {
                            "addressPrefix": "[parameters('AzureFirewallSubnetPrefix')]"
                        }
                    },
                    {
                        "name": "[parameters('AppGatewaySubnetName')]",
                        "properties": {
                            "addressPrefix": "[parameters('AppGatewaySubnetPrefix')]"
                        }
                    },
                    {
                        "name": "[parameters('ADSubnetName')]",
                        "properties": {
                            "addressPrefix": "[parameters('ADSubnetPrefix')]"
                        }
                    },
                    {
                        "name": "[parameters('PrdApplicationSubnetName')]",
                        "properties": {
                            "addressPrefix": "[parameters('PrdApplicationSubnetPrefix')]"
                        }
                    },
                    {
                        "name": "[parameters('PrdDataSubnetName')]",
                        "properties": {
                            "addressPrefix": "[parameters('PrdDataSubnetPrefix')]"
                        }
                    },
                    {
                        "name": "[parameters('PrdWebSubnetName')]",
                        "properties": {
                            "addressPrefix": "[parameters('PrdWebSubnetPrefix')]"
                        }
                    }
                ]
            },
            "dependsOn": []
        },
        {
            "condition": "[equals(parameters('deployazurefirewall'),'Yes')]",
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[variables('AzureFirewallPIPName')]",
            "apiVersion": "2017-10-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
              "sku": {
                "name": "Standard",
                "tier": "Regional"
            },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4,
                "ipTags": []
            }
        },
        {
            "condition": "[equals(parameters('deployazurefirewall'),'Yes')]",
            "type": "Microsoft.Network/azureFirewalls",
            "name": "[parameters('AzureFirewallName')]",
            "apiVersion": "2018-10-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
            "properties": {
                "provisioningState": "Succeeded",
                "ipConfigurations": [
                    {
                        "name": "IpConf",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('AzureFirewallPIPName'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('ProdVNetName'), 'AzureFirewallSubnet')]"
                            }
                        }
                    }
                ],
                "networkRuleCollections": [
                    {
                        "name": "Base_Rules",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "priority": 1000,
                            "action": {
                                "type": "Allow"
                            },
                            "rules": [
                                {
                                    "name": "AnyRDP",
                                    "protocols": [
                                        "TCP"
                                    ],
                                    "sourceAddresses": [
                                        "*"
                                    ],
                                    "destinationAddresses": [
                                        "*"
                                    ],
                                    "destinationPorts": [
                                        "3389"
                                    ]
                                },
                                {
                                    "name": "Web Browsing",
                                    "protocols": [
                                        "TCP"
                                    ],
                                    "sourceAddresses": [
                                        "*"
                                    ],
                                    "destinationAddresses": [
                                        "*"
                                    ],
                                    "destinationPorts": [
                                        "80",
                                        "443"
                                    ]
                                },
                                {
                                    "name": "Intrazone",
                                    "protocols": [
                                        "Any"
                                    ],
                                    "sourceAddresses": [
                                        "[parameters('ProdVNetPrefix')]",
                                        "[parameters('DevVNetPrefix')]"
                                    ],
                                    "destinationAddresses": [
                                        "[parameters('ProdVNetPrefix')]",
                                        "[parameters('DevVNetPrefix')]"
                                    ],
                                    "destinationPorts": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    }
                ],
                "applicationRuleCollections": [],
                "natRuleCollections": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('AzureFirewallPIPName'))]",
                "[variables('ProdVNetID')]"
            ]
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "name": "[concat(parameters('ProdVNetName'),'/',parameters('ProdVNetName'),'_to_',parameters('DevVNetName'),'_peering')]",
            "apiVersion": "2017-10-01",
            "properties": {
                "allowVirtualNetworkAccess": "true",
                "allowForwardedTraffic": "true",
                "allowGatewayTransit": "true",
                "useRemoteGateways": "false",
                "remoteVirtualNetwork": {
                    "id": "[resourceId(parameters('DevSubscriptionId'),parameters('DevResourceGroup'),'Microsoft.Network/virtualNetworks',parameters('DevVNetName'))]"
                },
                "remoteAddressSpace": {
                    "addressPrefixes": [
                        "[parameters('DevVNetPrefix')]"
                    ]
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'Nested_DevelopmentResources')]",
                "[concat('Microsoft.Network/virtualNetworks/', parameters('ProdVNetName'))]",
                "[concat('Microsoft.Network/virtualNetworkGateways/', parameters('VNetGatewayName'))]"
            ]
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[variables('VNetGatewayPIPName')]",
            "apiVersion": "2017-10-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
            "properties": {
                "publicIPAllocationMethod": "Dynamic"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworkGateways",
            "name": "[parameters('VNetGatewayName')]",
            "apiVersion": "2017-10-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
            "properties": {
                "ipConfigurations": [
                    {
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[variables('GatewaySubnetRef')]"
                            },
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('VNetGatewayPIPName'))]"
                            }
                        },
                        "name": "[concat(parameters('VNetGatewayName'),'ipconfig')]"
                    }
                ],
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "enableBgp": "false"
            },
            "dependsOn": [
                "[concat('Microsoft.Network/publicIPAddresses/', variables('VNetGatewayPIPName'))]",
                "[concat('Microsoft.Network/virtualNetworks/', parameters('ProdVNetName'))]"
            ]
        },
        {
            "type": "Microsoft.Network/localNetworkGateways",
            "name": "[parameters('LocalNetworkGatewayName')]",
            "apiVersion": "2017-10-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
            "properties": {
                "gatewayIpAddress": "[parameters('LocalNetworkGatewayIP')]",
                "localNetworkAddressSpace": {
                    "addressPrefixes": "[parameters('LocalNetworkGatewayAddressSpace')]"
                }
            },
            "dependsOn": []
        },
        {
            "type": "Microsoft.Network/routeTables",
            "name": "[parameters('GatewayRouteTableName')]",
            "apiVersion": "2018-01-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
            "properties": {
                "provisioningState": "Succeeded",
                "disableBgpRoutePropagation": false,
                "routes": [
                    {
                        "name": "Default",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "0.0.0.0/0",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "1.1.1.1"
                        }
                    },
                    {
                        "name": "[variables('GatewayRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('GatewaySubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "1.1.1.1"
                        }
                    },
                    {
                        "name": "[variables('AppGatewayRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('AppGatewaySubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "1.1.1.1"
                        }
                    },
                    {
                        "name": "[variables('ADRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('ADSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "1.1.1.1"
                        }
                    },
                    {
                        "name": "[variables('PrdApplicationRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdApplicationSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "1.1.1.1"
                        }
                    },
                    {
                        "name": "[variables('PrdDataRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdDataSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "1.1.1.1"
                        }
                    },
                    {
                        "name": "[variables('PrdWebRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdWebSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "1.1.1.1"
                        }
                    },
                    {
                        "name": "[variables('DevApplicationRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevApplicationSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "1.1.1.1"
                        }
                    },
                    {
                        "name": "[variables('DevDataRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevDataSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "1.1.1.1"
                        }
                    },
                    {
                        "name": "[variables('DevWebRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevWebSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "1.1.1.1"
                        }
                    },
                    {
                        "name": "AzureEventHub",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "52.244.48.85/32",
                            "nextHopType": "Internet"
                        }
                    },
                    {
                        "name": "AzureCloud",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "23.97.0.0/20",
                            "nextHopType": "Internet"
                        }
                    }
                ]
            },
            "dependsOn": []
        },
        {
            "type": "Microsoft.Network/routeTables",
            "name": "[parameters('AzureFirewallRouteTableName')]",
            "apiVersion": "2018-01-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
            "properties": {
                "provisioningState": "Succeeded",
                "disableBgpRoutePropagation": false,
                "routes": [
                    {
                        "name": "Default",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "0.0.0.0/0",
                            "nextHopType": "Internet"
                        }
                    }
                ]
            },
            "dependsOn": []
        },
        {
            "type": "Microsoft.Network/routeTables",
            "name": "[parameters('AppGatewayRouteTableName')]",
            "apiVersion": "2018-01-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
            "properties": {
                "provisioningState": "Succeeded",
                "disableBgpRoutePropagation": false,
                "routes": [
                    {
                        "name": "Default",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "0.0.0.0/0",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "2.2.2.2"
                        }
                    },
                    {
                        "name": "[variables('GatewayRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('GatewaySubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "2.2.2.2"
                        }
                    },
                    {
                        "name": "[variables('AppGatewayRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('AppGatewaySubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "2.2.2.2"
                        }
                    },
                    {
                        "name": "[variables('ADRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('ADSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "2.2.2.2"
                        }
                    },
                    {
                        "name": "[variables('PrdApplicationRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdApplicationSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "2.2.2.2"
                        }
                    },
                    {
                        "name": "[variables('PrdDataRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdDataSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "2.2.2.2"
                        }
                    },
                    {
                        "name": "[variables('PrdWebRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdWebSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "2.2.2.2"
                        }
                    },
                    {
                        "name": "[variables('DevApplicationRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevApplicationSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "2.2.2.2"
                        }
                    },
                    {
                        "name": "[variables('DevDataRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevDataSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "2.2.2.2"
                        }
                    },
                    {
                        "name": "[variables('DevWebRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevWebSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "2.2.2.2"
                        }
                    },
                    {
                        "name": "AzureEventHub",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "52.244.48.85/32",
                            "nextHopType": "Internet"
                        }
                    },
                    {
                        "name": "AzureCloud",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "23.97.0.0/20",
                            "nextHopType": "Internet"
                        }
                    }
                ]
            },
            "dependsOn": []
        },
        {
            "type": "Microsoft.Network/routeTables",
            "name": "[parameters('ADRouteTableName')]",
            "apiVersion": "2018-01-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
            "properties": {
                "provisioningState": "Succeeded",
                "disableBgpRoutePropagation": false,
                "routes": [
                    {
                        "name": "Default",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "0.0.0.0/0",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('GatewayRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('GatewaySubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('AppGatewayRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('AppGatewaySubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('ADRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('ADSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('PrdApplicationRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdApplicationSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('PrdDataRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdDataSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('PrdWebRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdWebSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('DevApplicationRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevApplicationSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('DevDataRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevDataSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('DevWebRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevWebSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "AzureEventHub",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "52.244.48.85/32",
                            "nextHopType": "Internet"
                        }
                    },
                    {
                        "name": "AzureCloud",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "23.97.0.0/20",
                            "nextHopType": "Internet"
                        }
                    }
                ]
            },
            "dependsOn": []
        },
        {
            "type": "Microsoft.Network/routeTables",
            "name": "[parameters('PrdApplicationRouteTableName')]",
            "apiVersion": "2018-01-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
            "properties": {
                "provisioningState": "Succeeded",
                "disableBgpRoutePropagation": false,
                "routes": [
                    {
                        "name": "Default",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "0.0.0.0/0",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('GatewayRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('GatewaySubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('AppGatewayRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('AppGatewaySubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('ADRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('ADSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('PrdApplicationRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdApplicationSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('PrdDataRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdDataSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('PrdWebRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdWebSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('DevApplicationRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevApplicationSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('DevDataRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevDataSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('DevWebRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevWebSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "AzureEventHub",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "52.244.48.85/32",
                            "nextHopType": "Internet"
                        }
                    },
                    {
                        "name": "AzureCloud",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "23.97.0.0/20",
                            "nextHopType": "Internet"
                        }
                    }
                ]
            },
            "dependsOn": []
        },
        {
            "type": "Microsoft.Network/routeTables",
            "name": "[parameters('PrdDataRouteTableName')]",
            "apiVersion": "2018-01-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
            "properties": {
                "provisioningState": "Succeeded",
                "disableBgpRoutePropagation": false,
                "routes": [
                    {
                        "name": "Default",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "0.0.0.0/0",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('GatewayRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('GatewaySubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('AppGatewayRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('AppGatewaySubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('ADRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('ADSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('PrdApplicationRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdApplicationSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('PrdDataRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdDataSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('PrdWebRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdWebSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('DevApplicationRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevApplicationSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('DevDataRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevDataSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('DevWebRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevWebSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "AzureEventHub",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "52.244.48.85/32",
                            "nextHopType": "Internet"
                        }
                    },
                    {
                        "name": "AzureCloud",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "23.97.0.0/20",
                            "nextHopType": "Internet"
                        }
                    }
                ]
            },
            "dependsOn": []
        },
        {
            "type": "Microsoft.Network/routeTables",
            "name": "[parameters('PrdWebRouteTableName')]",
            "apiVersion": "2018-01-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Owner": "[parameters('OwnerTag')]",
                "Email": "[parameters('EmailTag')]"
            },
            "properties": {
                "provisioningState": "Succeeded",
                "disableBgpRoutePropagation": false,
                "routes": [
                    {
                        "name": "Default",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "0.0.0.0/0",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('GatewayRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('GatewaySubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('AppGatewayRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('AppGatewaySubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('ADRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('ADSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('PrdApplicationRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdApplicationSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('PrdDataRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdDataSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('PrdWebRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('PrdWebSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('DevApplicationRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevApplicationSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('DevDataRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevDataSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "[variables('DevWebRouteName')]",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "[parameters('DevWebSubnetPrefix')]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "3.3.3.3"
                        }
                    },
                    {
                        "name": "AzureEventHub",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "52.244.48.85/32",
                            "nextHopType": "Internet"
                        }
                    },
                    {
                        "name": "AzureCloud",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "23.97.0.0/20",
                            "nextHopType": "Internet"
                        }
                    }
                ]
            },
            "dependsOn": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "Nested_DevelopmentResources",
            "apiVersion": "2017-05-10",
            "subscriptionId": "[parameters('DevSubscriptionId')]",
            "resourceGroup": "[parameters('DevResourceGroup')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[parameters('DevVNetName')]",
                            "type": "Microsoft.Network/virtualNetworks",
                            "location": "[resourceGroup().location]",
                            "apiVersion": "2015-06-15",
                            "dependsOn": [],
                            "tags": {
                                "Owner": "[parameters('OwnerTag')]",
                                "Email": "[parameters('EmailTag')]"
                            },
                            "properties": {
                                "addressSpace": {
                                    "addressPrefixes": [
                                        "[parameters('DevVNetPrefix')]"
                                    ]
                                },
                                "subnets": [
                                    {
                                        "name": "[parameters('DevApplicationSubnetName')]",
                                        "properties": {
                                            "addressPrefix": "[parameters('DevApplicationSubnetPrefix')]"
                                        }
                                    },
                                    {
                                        "name": "[parameters('DevDataSubnetName')]",
                                        "properties": {
                                            "addressPrefix": "[parameters('DevDataSubnetPrefix')]"
                                        }
                                    },
                                    {
                                        "name": "[parameters('DevWebSubnetName')]",
                                        "properties": {
                                            "addressPrefix": "[parameters('DevWebSubnetPrefix')]"
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.Network/routeTables",
                            "name": "[parameters('DevApplicationRouteTableName')]",
                            "apiVersion": "2018-01-01",
                            "location": "[resourceGroup().location]",
                            "tags": {
                                "Owner": "[parameters('OwnerTag')]",
                                "Email": "[parameters('EmailTag')]"
                            },
                            "scale": null,
                            "properties": {
                                "provisioningState": "Succeeded",
                                "disableBgpRoutePropagation": false,
                                "routes": [
                                    {
                                        "name": "Default",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "0.0.0.0/0",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('GatewayRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('GatewaySubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('AppGatewayRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('AppGatewaySubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('ADRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('ADSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('PrdApplicationRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('PrdApplicationSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('PrdDataRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('PrdDataSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('PrdWebRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('PrdWebSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('DevApplicationRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('DevApplicationSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('DevDataRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('DevDataSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('DevWebRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('DevWebSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "AzureEventHub",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "52.244.48.85/32",
                                            "nextHopType": "Internet"
                                        }
                                    },
                                    {
                                        "name": "AzureCloud",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "23.97.0.0/20",
                                            "nextHopType": "Internet"
                                        }
                                    }
                                ]
                            },
                            "dependsOn": []
                        },
                        {
                            "type": "Microsoft.Network/routeTables",
                            "name": "[parameters('DevDataRouteTableName')]",
                            "apiVersion": "2018-01-01",
                            "location": "[resourceGroup().location]",
                            "tags": {
                                "Owner": "[parameters('OwnerTag')]",
                                "Email": "[parameters('EmailTag')]"
                            },
                            "scale": null,
                            "properties": {
                                "provisioningState": "Succeeded",
                                "disableBgpRoutePropagation": false,
                                "routes": [
                                    {
                                        "name": "Default",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "0.0.0.0/0",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('GatewayRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('GatewaySubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('AppGatewayRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('AppGatewaySubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('ADRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('ADSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('PrdApplicationRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('PrdApplicationSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('PrdDataRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('PrdDataSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('PrdWebRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('PrdWebSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('DevApplicationRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('DevApplicationSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('DevDataRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('DevDataSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('DevWebRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('DevWebSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "AzureEventHub",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "52.244.48.85/32",
                                            "nextHopType": "Internet"
                                        }
                                    },
                                    {
                                        "name": "AzureCloud",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "23.97.0.0/20",
                                            "nextHopType": "Internet"
                                        }
                                    }
                                ]
                            },
                            "dependsOn": []
                        },
                        {
                            "type": "Microsoft.Network/routeTables",
                            "name": "[parameters('DevWebRouteTableName')]",
                            "apiVersion": "2018-01-01",
                            "location": "[resourceGroup().location]",
                            "tags": {
                                "Owner": "[parameters('OwnerTag')]",
                                "Email": "[parameters('EmailTag')]"
                            },
                            "scale": null,
                            "properties": {
                                "provisioningState": "Succeeded",
                                "disableBgpRoutePropagation": false,
                                "routes": [
                                    {
                                        "name": "Default",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "0.0.0.0/0",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('GatewayRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('GatewaySubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('AppGatewayRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('AppGatewaySubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('ADRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('ADSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('PrdApplicationRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('PrdApplicationSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('PrdDataRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('PrdDataSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('PrdWebRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('PrdWebSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('DevApplicationRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('DevApplicationSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('DevDataRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('DevDataSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "[variables('DevWebRouteName')]",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "[parameters('DevWebSubnetPrefix')]",
                                            "nextHopType": "VirtualAppliance",
                                            "nextHopIpAddress": "3.3.3.3"
                                        }
                                    },
                                    {
                                        "name": "AzureEventHub",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "52.244.48.85/32",
                                            "nextHopType": "Internet"
                                        }
                                    },
                                    {
                                        "name": "AzureCloud",
                                        "properties": {
                                            "provisioningState": "Succeeded",
                                            "addressPrefix": "23.97.0.0/20",
                                            "nextHopType": "Internet"
                                        }
                                    }
                                ]
                            },
                            "dependsOn": []
                        }
                    ]
                }
            },
            "condition": "[equals(parameters('deploydev'),'Yes')]"
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "Nested_DevelopmentPeering",
            "apiVersion": "2018-01-01",
            "subscriptionId": "[parameters('DevSubscriptionId')]",
            "resourceGroup": "[parameters('DevResourceGroup')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[concat(parameters('DevVNetName'),'/',parameters('DevVNetName'),'_to_',parameters('ProdVNetName'),'_peering')]",
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "apiVersion": "2017-10-01",
                            "properties": {
                                "allowVirtualNetworkAccess": "true",
                                "allowForwardedTraffic": "true",
                                "allowGatewayTransit": "false",
                                "useRemoteGateways": "true",
                                "remoteVirtualNetwork": {
                                    "id": "[variables('ProdVNetID')]"
                                },
                                "remoteAddressSpace": {
                                    "addressPrefixes": [
                                        "[parameters('ProdVNetPrefix')]"
                                    ]
                                }
                            }
                        }
                    ]
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'Nested_DevelopmentResources')]",
                "[concat('Microsoft.Network/virtualNetworks/', parameters('ProdVNetName'))]",
                "[concat('Microsoft.Network/virtualNetworkGateways/', parameters('VNetGatewayName'))]"
            ],
            "condition": "[equals(parameters('deploydev'),'Yes')]"
        }
    ]
}